<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payslip Generator sa Lagum (Cloud Sync)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and ReactDOM (Global Access) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Load Firebase Modules (Auth and Firestore) -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Expose Firebase functions globally so the React/Babel script tag can access them
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.setLogLevel = setLogLevel;
    </script>

    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; }
        /* Prevents strange touch delay on buttons for mobile */
        button { touch-action: manipulation; } 
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const currency = 'â‚±'; 
        
        // =========================================================
        // !!! CRITICAL: FIREBASE CONFIGURATION (PASTED BY USER) !!!
        // This is used to connect to your personal Firestore database.
        const userFirebaseConfig = {
             apiKey: "AIzaSyBK94w1LslQlZpowcEytMWI20iUbXQYBv4",
             authDomain: "payslip-6e83f.firebaseapp.com",
             projectId: "payslip-6e83f",
             storageBucket: "payslip-6e83f.firebasestorage.app",
             messagingSenderId: "804926507342",
             appId: "1:804926507342:web:f0c3b19786574d18ab761f",
             measurementId: "G-TJE0RCHW4P"
        };
        // =========================================================

        const FIREBASE_ENABLED = userFirebaseConfig.projectId && userFirebaseConfig.apiKey;
        const LOCAL_STORAGE_KEY = 'payslip_generator_data_cloud_fallback';
        
        // --- CORE STATE ---
        const DEFAULT_PAYSLIP_STATE = {
            staffName: "",
            payMode: 'daily',
            rateInput: 500,
            // Initializes to today's date formatted as YYYY-MM-DD
            startDate: new Date().toISOString().substr(0, 10), 
            attendance: Array(15).fill(true), // 15 days, all true (Present)
        };

        // Custom Message Box Function for notifications
        const showMessageBox = (message, type = 'info') => {
            const messageContainer = document.getElementById('message-box');
            if (!messageContainer) return;
            
            messageContainer.textContent = message;
            messageContainer.classList.remove('hidden', 'opacity-0');
            messageContainer.classList.add('opacity-100');

            messageContainer.className = `fixed top-4 right-4 p-3 px-4 rounded-xl shadow-2xl text-sm z-50 transition-all duration-300 transform translate-y-0 opacity-100 
                                            ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white`;
            
            setTimeout(() => {
                messageContainer.classList.remove('opacity-100');
                messageContainer.classList.add('opacity-0');
                setTimeout(() => messageContainer.classList.add('hidden'), 300);
            }, 4000);
        };


        // --- FIRESTORE / LOCAL STORAGE FUNCTIONS ---
        
        // Local Storage Fallback Functions
        const loadLocalData = () => {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Handle attendance string conversion if needed
                    if (typeof parsedData.attendance === 'string') {
                         parsedData.attendance = JSON.parse(parsedData.attendance);
                    }
                    return { ...DEFAULT_PAYSLIP_STATE, ...parsedData };
                }
            } catch (error) {
                console.error("Error loading local data:", error);
            }
            return DEFAULT_PAYSLIP_STATE;
        };

        const saveLocalData = (data) => {
            try {
                const dataToStore = {
                    ...data,
                    // Store array as JSON string for Local Storage compatibility
                    attendance: JSON.stringify(data.attendance) 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToStore));
            } catch (error) {
                console.error("Error saving local data:", error);
            }
        };

        // Firebase State and References
        let db = null;
        let userId = null;
        // Using a simple collection and document ID since this is a single-user app for now
        const PAYSLIP_COLLECTION = 'payslips'; 
        const PAYSLIP_DOC_ID = 'staff_data'; 

        // Write data to Firestore
        const writeToFirestore = (data) => {
            if (!db || !userId) return;
            
            const dataToSave = {
                ...data,
                // Store array as JSON string for Firestore compatibility (best practice)
                attendance: JSON.stringify(data.attendance), 
            };

            const docRef = window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID);
            // Use merge: true to avoid overwriting the entire document
            window.setDoc(docRef, dataToSave, { merge: true })
                .then(() => showMessageBox("Data synced to the Cloud!"))
                .catch(error => console.error("Firestore Write Error:", error));
        };

        // --- REACT COMPONENT ---
        function App() {
            const [payslipData, setPayslipData] = useState(DEFAULT_PAYSLIP_STATE);
            const [isSaving, setIsSaving] = useState(false);
            const [isCloudMode, setIsCloudMode] = useState(false);
            const [isDataReady, setIsDataReady] = useState(false);
            
            const isInitialLoad = useRef(true); 

            // 1. Firebase Initialization and Auth
            useEffect(() => {
                if (FIREBASE_ENABLED && window.getFirestore) {
                    try {
                        // setLogLevel('Debug'); // Uncomment for debugging Firestore traffic
                        const app = window.initializeApp(userFirebaseConfig);
                        const auth = window.getAuth(app);
                        db = window.getFirestore(app);
                        
                        // Listen for auth state changes
                        window.onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid; // Store the unique anonymous ID
                                setIsCloudMode(true);
                                console.log("Cloud Mode: Signed in anonymously. UID:", userId);
                            } else {
                                // Attempt anonymous sign-in if not signed in
                                window.signInAnonymously(auth).catch(e => {
                                    console.error("Anonymous Sign-in failed:", e);
                                    setIsCloudMode(false); 
                                    setIsDataReady(true);
                                    setPayslipData(loadLocalData());
                                });
                            }
                        });
                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                        setIsCloudMode(false);
                        setIsDataReady(true);
                        setPayslipData(loadLocalData());
                    }
                } else {
                    // Fallback to Local Storage immediately if config is missing
                    setPayslipData(loadLocalData());
                    setIsDataReady(true);
                    showMessageBox("Firebase Config Missing. Running in Local Mode.", 'error');
                }
            }, []); 

            // 2. Firestore Listener (Cloud Mode)
            useEffect(() => {
                // Only run this effect if we are in Cloud Mode and Firebase resources are ready
                if (!isCloudMode || !db || !userId) return;

                const docRef = window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID);
                
                // Set up the real-time listener
                const unsubscribe = window.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        let data = docSnap.data();
                        
                        // Parse attendance back into an array from the stored JSON string
                        if (data.attendance && typeof data.attendance === 'string') {
                            try {
                                data.attendance = JSON.parse(data.attendance);
                            } catch (e) {
                                console.error("Error parsing attendance:", e);
                                data.attendance = DEFAULT_PAYSLIP_STATE.attendance;
                            }
                        }
                        
                        // Merge loaded data with defaults
                        setPayslipData(prev => ({ ...DEFAULT_PAYSLIP_STATE, ...data }));
                        
                        if (!isDataReady) {
                             // Only show ready message after initial fetch
                            showMessageBox("Cloud data loaded!");
                            setIsDataReady(true);
                        }
                    } else if (!isDataReady) {
                        // Document doesn't exist, use default state for the first time
                        setPayslipData(DEFAULT_PAYSLIP_STATE);
                        setIsDataReady(true);
                        console.log("No existing cloud data. Using default state.");
                    }
                }, error => {
                    // Handle disconnection/permission errors
                    console.error("Firestore Listener Error:", error);
                    showMessageBox("Cloud connection error. Check rules. Switching to Local Mode.", 'error');
                    setIsCloudMode(false);
                    setIsDataReady(true);
                    setPayslipData(loadLocalData()); // Load local data as fallback
                });

                return () => unsubscribe(); // Cleanup the listener when component unmounts
            }, [isCloudMode, isDataReady]); // Dependencies trigger the listener setup

            // 3. Debounced Saving Effect (Cloud or Local)
            useEffect(() => {
                if (!isDataReady) return; // Wait until data is loaded/initialized

                // Skip the initial render to prevent overwriting cloud data immediately
                if (isInitialLoad.current) {
                    isInitialLoad.current = false;
                    return;
                }

                setIsSaving(true);
                // Debounce the saving to avoid excessive writes/storage calls
                const timeoutId = setTimeout(() => {
                    if (isCloudMode) {
                        writeToFirestore(payslipData);
                    } else {
                        saveLocalData(payslipData);
                        showMessageBox("Data saved locally!");
                    }
                    setIsSaving(false);
                }, 500); 

                return () => clearTimeout(timeoutId); // Cleanup timeout
            }, [payslipData, isCloudMode, isDataReady]); // Trigger save when data changes

            // Helper to update state and trigger save
            const updatePayslipData = (key, value) => {
                setPayslipData(prev => ({
                    ...prev,
                    [key]: value
                }));
            };

            // --- CALCULATIONS & HANDLERS ---
            const { payMode, rateInput, startDate, attendance } = payslipData;
            
            const totalDays = 15;
            const daysPresent = attendance.filter(Boolean).length;

            const getCalculatedValues = () => {
                let dailyRate = 0;
                let totalPayable = 0;

                if (payMode === 'daily') {
                    dailyRate = parseFloat(rateInput) || 0;
                    totalPayable = dailyRate * daysPresent;
                } else {
                    const totalFixed = parseFloat(rateInput) || 0;
                    dailyRate = totalDays > 0 ? totalFixed / totalDays : 0;
                    totalPayable = dailyRate * daysPresent;
                }

                return { dailyRate, totalPayable };
            };

            const { dailyRate, totalPayable } = getCalculatedValues();

            const getDisplayDate = (dayIndex) => {
                const date = new Date(startDate);
                date.setDate(date.getDate() + dayIndex);
                // Use PH locale style
                return date.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', weekday: 'short' }); 
            };

            const toggleDay = (index) => {
                const newAttendance = [...attendance];
                newAttendance[index] = !newAttendance[index];
                updatePayslipData('attendance', newAttendance);
            };

            const resetAttendance = () => {
                // Using a simple confirm since custom modal would add complexity
                const userConfirmed = window.confirm("Are you sure you want to reset all days to Present? This cannot be undone.");
                if (userConfirmed) {
                    updatePayslipData('attendance', Array(15).fill(true));
                }
            };
            
            if (!isDataReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-xl text-slate-500 flex items-center gap-3">
                            <svg className="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Connecting to Firebase Cloud...
                        </div>
                    </div>
                );
            }

            // --- PDF GENERATION LOGIC ---
            const generatePDF = () => {
                if (!payslipData.staffName.trim()) {
                    const nameInputContainer = document.getElementById('name-input-container');
                    if (nameInputContainer) {
                         nameInputContainer.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => {
                            nameInputContainer.classList.remove('ring-2', 'ring-red-500');
                        }, 3000);
                    }
                    showMessageBox("Error: Please enter the Staff Name before generating the Payslip.", 'error');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [49, 46, 129]; // Indigo-700 equivalent 

                // Header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.text("Payslip Generator sa Lagum Report", 105, 20, { align: "center" });
                doc.setFontSize(12);
                doc.text("15-Day Payment Period Summary", 105, 30, { align: "center" });

                // Staff Details
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.text(`Staff Name: ${payslipData.staffName}`, 20, 60);
                doc.setFontSize(11);
                doc.text(`Start Date: ${getDisplayDate(0)}`, 20, 70);
                doc.text(`End Date: ${getDisplayDate(14)}`, 20, 78);

                // Financial Summary Box
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.1);
                doc.rect(120, 55, 70, 35);
                
                doc.setFontSize(10);
                doc.text("Total Payable Amount (PHP):", 125, 65);
                doc.setFontSize(18);
                doc.setTextColor(22, 163, 74); // Green 600
                doc.text(`${currency} ${totalPayable.toFixed(2)}`, 125, 75);
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`(Based on ${daysPresent} days present)`, 125, 82);

                // Table Header
                let yPos = 100;
                doc.setTextColor(0,0,0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Attendance Breakdown", 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos-5, 170, 8, 'F');
                doc.text("Date", 25, yPos);
                doc.text("Status", 100, yPos);
                doc.text("Value", 160, yPos);

                // Table Rows
                yPos += 10;
                doc.setFont(undefined, 'normal');
                
                attendance.forEach((isPresent, index) => {
                    const dateStr = getDisplayDate(index);
                    const status = isPresent ? "Present" : "Absent";
                    const val = isPresent ? `${currency} ${dailyRate.toFixed(2)}` : "-";

                    if (yPos > 270) { 
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.text(dateStr, 25, yPos);
                    
                    if (isPresent) {
                        doc.setTextColor(22, 163, 74); // Green 600
                    } else {
                        doc.setTextColor(156, 163, 175); // Slate 400 
                    }
                    doc.text(status, 100, yPos);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.text(val, 160, yPos);
                    
                    yPos += 8;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Generated by Payslip Generator sa Lagum (${isCloudMode ? 'Cloud Mode' : 'Local Mode'})`, 105, 290, { align: "center" });

                // Save
                const safeName = payslipData.staffName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'untitled_staff';
                doc.save(`${safeName}_payslip.pdf`);
            };

            return (
                <div className="min-h-screen p-4 md:p-8 font-sans text-gray-800 flex justify-center">
                    
                    {/* Floating Message Box */}
                    <div id="message-box" className="hidden fixed top-4 right-4 p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity">
                        Data Synchronized!
                    </div>
                    {/* Saving Indicator */}
                    {isSaving && (
                        <div className={`fixed bottom-4 right-4 ${isCloudMode ? 'bg-indigo-500' : 'bg-yellow-500'} text-white p-2 px-4 rounded-full shadow-lg text-xs z-50`}>
                            {isCloudMode ? 'Syncing to Cloud...' : 'Saving locally...'}
                        </div>
                    )}


                    <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
                        
                        {/* Top Header */}
                        <div className="bg-indigo-700 p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <span className="text-3xl">ðŸ‡µðŸ‡­</span> Payslip Generator sa Lagum
                                </h1>
                                <p className={`text-sm font-bold ${isCloudMode ? 'text-green-300' : 'text-yellow-300'}`}>
                                    {isCloudMode ? 'Cloud Mode (Data syncs across all devices)' : 'Local Mode (Data saves per device)'}
                                </p>
                            </div>
                            <div className="text-center bg-indigo-600 px-6 py-3 rounded-xl border border-indigo-500">
                                <p className="text-xs text-indigo-200 uppercase tracking-wide">Current Payout</p>
                                <p className="text-3xl font-bold text-green-300">{currency} {totalPayable.toFixed(2)}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12">
                            
                            {/* LEFT SIDEBAR (Controls) */}
                            <div className="lg:col-span-4 bg-slate-50 p-6 border-b lg:border-b-0 lg:border-r border-slate-200 flex flex-col gap-6">
                                
                                {/* Staff Name Input */}
                                <div id="name-input-container" className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 transition-all duration-300">
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Staff Name</label>
                                    <input 
                                        type="text" 
                                        value={payslipData.staffName}
                                        onChange={(e) => updatePayslipData('staffName', e.target.value)}
                                        placeholder="e.g. Juan Dela Cruz"
                                        className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50"
                                    />
                                </div>

                                {/* Settings */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Pay Settings</label>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-4">
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => updatePayslipData('payMode', 'daily')} className={`py-2 text-sm font-medium rounded-lg transition-all ${payMode === 'daily' ? 'bg-indigo-500 text-indigo-50 shadow-md' : 'bg-slate-200 text-slate-600'}`}>Daily Rate</button>
                                            <button onClick={() => updatePayslipData('payMode', 'fixed')} className={`py-2 text-sm font-medium rounded-lg transition-all ${payMode === 'fixed' ? 'bg-indigo-500 text-indigo-50 shadow-md' : 'bg-slate-200 text-slate-600'}`}>Fixed Total</button>
                                        </div>
                                        
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-slate-400 font-bold">{currency}</span>
                                            <input 
                                                type="number" 
                                                value={payslipData.rateInput}
                                                onChange={(e) => updatePayslipData('rateInput', parseFloat(e.target.value) || 0)}
                                                className="w-full pl-8 p-2 border rounded-lg outline-none focus:border-indigo-500"
                                            />
                                            <span className="absolute right-3 top-3 text-xs text-slate-400">
                                                {payMode === 'daily' ? '/ day' : '/ 15 days'}
                                            </span>
                                        </div>

                                        <div>
                                            <label className="text-xs text-slate-400 block mb-1">Start Date</label>
                                            <input 
                                                type="date" 
                                                value={startDate}
                                                onChange={(e) => updatePayslipData('startDate', e.target.value)}
                                                className="w-full p-2 border rounded-lg text-sm text-slate-600"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Download Button */}
                                <button 
                                    onClick={generatePDF}
                                    className="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition-transform active:scale-95"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Download Payslip (PDF)
                                </button>

                            </div>

                            {/* RIGHT CONTENT (Grid) */}
                            <div className="lg:col-span-8 p-6 bg-white">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg text-slate-700">Attendance Log</h3>
                                    <div className="text-sm font-medium text-slate-500">
                                        {daysPresent} / {totalDays} Days
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    {attendance.map((isPresent, index) => (
                                        <button
                                            key={index}
                                            onClick={() => toggleDay(index)}
                                            className={`
                                                relative p-3 rounded-xl border-2 text-left transition-all group
                                                ${isPresent 
                                                    ? 'border-emerald-400 bg-emerald-50/30' 
                                                    : 'border-slate-100 bg-slate-50 opacity-60 hover:opacity-100'
                                                }
                                            `}
                                        >
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Day {index + 1}</span>
                                                {isPresent && <span className="w-2 h-2 rounded-full bg-emerald-500"></span>}
                                            </div>
                                            <div className="font-semibold text-slate-700 text-sm">
                                                {getDisplayDate(index)}
                                            </div>
                                            <div className={`text-xs mt-1 font-bold ${isPresent ? 'text-emerald-600' : 'text-slate-300'}`}>
                                                {isPresent ? `+${currency}${dailyRate.toFixed(0)}` : 'Absent'}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="mt-6 text-center">
                                    <button onClick={resetAttendance} className="text-xs text-slate-400 hover:text-red-500 underline">
                                        Clear all entries
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
