<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payslip Generator sa Lagum (Default Absent)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and ReactDOM (Global Access) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Load Firebase Modules (Auth and Firestore) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const currency = 'â‚±'; 
        
        // =========================================================
        // YOUR FIREBASE CONFIGURATION
        // =========================================================
        const userFirebaseConfig = {
             apiKey: "AIzaSyBK94w1LslQlZpowcEytMWI20iUbXQYBv4",
             authDomain: "payslip-6e83f.firebaseapp.com",
             projectId: "payslip-6e83f",
             storageBucket: "payslip-6e83f.firebasestorage.app",
             messagingSenderId: "804926507342",
             appId: "1:804926507342:web:f0c3b19786574d18ab761f",
             measurementId: "G-TJE0RCHW4P"
        };

        const FIREBASE_ENABLED = userFirebaseConfig.projectId && userFirebaseConfig.apiKey;
        const LOCAL_STORAGE_KEY = 'payslip_generator_v3_absent_default';
        
        // Calculate initial dates
        const today = new Date();
        const initialEnd = new Date(today);
        initialEnd.setDate(today.getDate() + 14); 

        // --- CORE STATE ---
        const DEFAULT_PAYSLIP_STATE = {
            staffName: "",
            payMode: 'daily',
            rateInput: 500,
            startDate: today.toISOString().substr(0, 10), 
            endDate: initialEnd.toISOString().substr(0, 10),
            daysCount: 15, 
            // CHANGED: Default to all false (Absent)
            attendance: Array(15).fill(false),
            history: [] 
        };

        const showMessageBox = (message, type = 'info') => {
            const messageContainer = document.getElementById('message-box');
            if (!messageContainer) return;
            
            messageContainer.textContent = message;
            messageContainer.classList.remove('hidden', 'opacity-0');
            messageContainer.classList.add('opacity-100');
            messageContainer.className = `fixed top-4 right-4 p-3 px-4 rounded-xl shadow-2xl text-sm z-50 transition-all duration-300 transform translate-y-0 opacity-100 
                                            ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white`;
            setTimeout(() => {
                messageContainer.classList.remove('opacity-100');
                messageContainer.classList.add('opacity-0');
                setTimeout(() => messageContainer.classList.add('hidden'), 300);
            }, 4000);
        };

        // --- DATA HANDLING ---
        const loadLocalData = () => {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    if (typeof parsed.attendance === 'string') parsed.attendance = JSON.parse(parsed.attendance);
                    if (typeof parsed.history === 'string') parsed.history = JSON.parse(parsed.history);
                    
                    // Migration logic for old data
                    if (!parsed.endDate && parsed.startDate) {
                        const e = new Date(parsed.startDate);
                        e.setDate(e.getDate() + (parsed.daysCount || 15) - 1);
                        parsed.endDate = e.toISOString().substr(0, 10);
                    }
                    
                    return { ...DEFAULT_PAYSLIP_STATE, ...parsed };
                }
            } catch (e) { console.error(e); }
            return DEFAULT_PAYSLIP_STATE;
        };

        const saveLocalData = (data) => {
            try {
                const store = { 
                    ...data, 
                    attendance: JSON.stringify(data.attendance),
                    history: JSON.stringify(data.history || [])
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(store));
            } catch (e) { console.error(e); }
        };

        let db = null;
        let userId = null;
        const PAYSLIP_COLLECTION = 'payslips'; 
        const PAYSLIP_DOC_ID = 'staff_data_v3'; // Changed ID to separate from previous version

        const writeToFirestore = (data) => {
            if (!db || !userId) return;
            const save = { 
                ...data, 
                attendance: JSON.stringify(data.attendance),
                history: JSON.stringify(data.history || [])
            };
            const docRef = window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID);
            window.setDoc(docRef, save, { merge: true })
                .then(() => showMessageBox("Synced!"))
                .catch(e => console.error(e));
        };

        // --- REACT COMPONENT ---
        function App() {
            const [state, setState] = useState(DEFAULT_PAYSLIP_STATE);
            const [isSaving, setIsSaving] = useState(false);
            const [isCloudMode, setIsCloudMode] = useState(false);
            const [isDataReady, setIsDataReady] = useState(false);
            const isInitialLoad = useRef(true); 

            // Firebase Init
            useEffect(() => {
                if (FIREBASE_ENABLED && window.getFirestore) {
                    try {
                        const app = window.initializeApp(userFirebaseConfig);
                        const auth = window.getAuth(app);
                        db = window.getFirestore(app);
                        window.onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                setIsCloudMode(true);
                            } else {
                                window.signInAnonymously(auth).catch(() => {
                                    setIsCloudMode(false);
                                    setIsDataReady(true);
                                    setState(loadLocalData());
                                });
                            }
                        });
                    } catch (e) {
                        setIsCloudMode(false);
                        setIsDataReady(true);
                        setState(loadLocalData());
                    }
                } else {
                    setIsDataReady(true);
                    setState(loadLocalData());
                }
            }, []); 

            // Firestore Listener
            useEffect(() => {
                if (!isCloudMode || !db || !userId) return;
                const docRef = window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID);
                const unsub = window.onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        let d = snap.data();
                        if (typeof d.attendance === 'string') d.attendance = JSON.parse(d.attendance);
                        if (typeof d.history === 'string') d.history = JSON.parse(d.history);
                        
                        if (!d.endDate && d.startDate) {
                             const e = new Date(d.startDate);
                             e.setDate(e.getDate() + (d.daysCount || 15) - 1);
                             d.endDate = e.toISOString().substr(0, 10);
                        }

                        setState(prev => ({ ...DEFAULT_PAYSLIP_STATE, ...d }));
                        if (!isDataReady) { showMessageBox("Cloud data loaded!"); setIsDataReady(true); }
                    } else if (!isDataReady) {
                        setIsDataReady(true);
                    }
                }, () => {
                    setIsCloudMode(false);
                    setIsDataReady(true);
                    setState(loadLocalData());
                });
                return () => unsub();
            }, [isCloudMode, isDataReady]);

            // Save Effect
            useEffect(() => {
                if (!isDataReady) return;
                if (isInitialLoad.current) { isInitialLoad.current = false; return; }
                
                setIsSaving(true);
                const t = setTimeout(() => {
                    if (isCloudMode) writeToFirestore(state);
                    else saveLocalData(state);
                    setIsSaving(false);
                }, 500);
                return () => clearTimeout(t);
            }, [state, isCloudMode, isDataReady]);

            const updateState = (key, val) => setState(prev => ({ ...prev, [key]: val }));

            // --- LOGIC ---
            const handleDateRangeChange = (type, value) => {
                let start = type === 'start' ? new Date(value) : new Date(state.startDate);
                let end = type === 'end' ? new Date(value) : new Date(state.endDate);

                if (end < start) {
                    if (type === 'start') end = new Date(start);
                    else start = new Date(end);
                }

                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // CHANGED: Default new days to FALSE (Absent)
                const newAtt = Array(diffDays).fill(false).map((v, i) => 
                    i < state.attendance.length ? state.attendance[i] : false
                );

                setState(prev => ({ 
                    ...prev, 
                    startDate: start.toISOString().substr(0, 10),
                    endDate: end.toISOString().substr(0, 10),
                    daysCount: diffDays, 
                    attendance: newAtt 
                }));
            };

            const toggleDay = (i) => {
                const newAtt = [...state.attendance];
                newAtt[i] = !newAtt[i];
                updateState('attendance', newAtt);
            };

            // NEW: Bulk update helper
            const setAllAttendance = (status) => {
                 updateState('attendance', Array(state.daysCount).fill(status));
            };

            const daysPresent = state.attendance.filter(Boolean).length;
            
            const getCalculated = (mode, rate, days, totalDays) => {
                let dRate = 0, total = 0;
                if (mode === 'daily') {
                    dRate = parseFloat(rate) || 0;
                    total = dRate * days;
                } else {
                    const fixed = parseFloat(rate) || 0;
                    dRate = totalDays > 0 ? fixed / totalDays : 0;
                    total = dRate * days;
                }
                return { dRate, total };
            };

            const { dRate: dailyRate, total: totalPayable } = getCalculated(state.payMode, state.rateInput, daysPresent, state.daysCount);

            const getDisplayDate = (start, offset) => {
                const d = new Date(start);
                d.setDate(d.getDate() + offset);
                return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', weekday: 'short' });
            };

            const formatFullDate = (dateStr) => {
                 const d = new Date(dateStr);
                 return d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });
            };

            // --- HISTORY LOGIC ---
            const saveToHistory = () => {
                if (!state.staffName) { showMessageBox("Enter Name first!", "error"); return; }
                
                const confirmSave = window.confirm(`Save record for ${state.staffName} and start a NEW period?`);
                if (!confirmSave) return;

                const record = {
                    id: Date.now(),
                    dateSaved: new Date().toLocaleDateString('en-PH'),
                    staffName: state.staffName,
                    startDate: state.startDate,
                    endDate: state.endDate, 
                    daysCount: state.daysCount,
                    daysPresent: daysPresent,
                    totalPayable: totalPayable,
                    payMode: state.payMode,
                    rateInput: state.rateInput,
                    attendance: [...state.attendance] 
                };

                // CHANGED: Reset attendance to FALSE (Absent) for new period
                setState(prev => ({
                    ...prev,
                    history: [record, ...(prev.history || [])],
                    attendance: Array(prev.daysCount).fill(false)
                }));
                
                showMessageBox("Record Saved to History!");
            };

            const deleteHistoryItem = (id) => {
                if(!window.confirm("Delete this history log?")) return;
                const newHist = state.history.filter(h => h.id !== id);
                updateState('history', newHist);
            };

            // --- PDF GENERATION ---
            const generatePDF = (data = null) => {
                const isHistory = !!data;
                const source = data || state;
                const currentDaysPresent = isHistory ? source.daysPresent : daysPresent;
                const currentTotal = isHistory ? source.totalPayable : totalPayable;
                const currentDailyRate = isHistory 
                    ? getCalculated(source.payMode, source.rateInput, source.daysPresent, source.daysCount).dRate
                    : dailyRate;

                if (!source.staffName) { showMessageBox("Name Missing!", "error"); return; }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [49, 46, 129]; 

                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.text("Payslip Report", 105, 20, { align: "center" });
                doc.setFontSize(12);
                doc.text(isHistory ? "Past Record Log" : "Current Period Summary", 105, 30, { align: "center" });

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.text(`Staff: ${source.staffName}`, 20, 60);
                doc.setFontSize(11);
                
                const sDate = source.startDate;
                const eDate = source.endDate || getDisplayDate(source.startDate, source.daysCount - 1);
                
                doc.text(`Period: ${formatFullDate(sDate)} to ${formatFullDate(eDate)}`, 20, 70);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 78);

                doc.setDrawColor(0); doc.setLineWidth(0.1); doc.rect(120, 55, 70, 35);
                doc.setFontSize(10); doc.text("Total Payout (PHP):", 125, 65);
                doc.setFontSize(18); doc.setTextColor(22, 163, 74);
                doc.text(`${currency} ${currentTotal.toFixed(2)}`, 125, 75);
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text(`(${currentDaysPresent} / ${source.daysCount} days present)`, 125, 82);

                let y = 100;
                doc.setTextColor(0); doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text("Attendance Log", 20, y); y+=10;
                
                doc.setFontSize(10); doc.setFillColor(240); doc.rect(20, y-5, 170, 8, 'F');
                doc.text("Date", 25, y); doc.text("Status", 100, y); doc.text("Value", 160, y);
                y+=10; doc.setFont(undefined, 'normal');

                source.attendance.forEach((p, i) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.text(getDisplayDate(source.startDate, i), 25, y);
                    if (p) doc.setTextColor(22, 163, 74); else doc.setTextColor(150);
                    doc.text(p ? "Present" : "Absent", 100, y);
                    doc.setTextColor(0);
                    doc.text(p ? `${currency} ${currentDailyRate.toFixed(2)}` : "-", 160, y);
                    y+=8;
                });

                doc.save(`${source.staffName}_${isHistory ? 'history' : 'current'}.pdf`);
            };

            if (!isDataReady) return <div className="min-h-screen flex items-center justify-center text-indigo-600">Loading...</div>;

            return (
                <div className="min-h-screen p-4 md:p-8 font-sans text-gray-800 flex justify-center">
                    <div id="message-box" className="hidden"></div>
                    {isSaving && <div className="fixed bottom-4 right-4 bg-indigo-500 text-white p-2 px-4 rounded-full text-xs z-50 shadow-lg">Syncing...</div>}

                    <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
                        {/* Header */}
                        <div className="bg-indigo-700 p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2"><span className="text-3xl">ðŸ‡µðŸ‡­</span> Payslip Generator</h1>
                                <p className={`text-xs font-bold ${isCloudMode ? 'text-green-300' : 'text-yellow-300'}`}>
                                    {isCloudMode ? 'Cloud Sync Active' : 'Local Mode'}
                                </p>
                            </div>
                            <div className="text-center bg-indigo-600 px-6 py-3 rounded-xl border border-indigo-500">
                                <p className="text-xs text-indigo-200 uppercase">Total Payout</p>
                                <p className="text-3xl font-bold text-green-300">{currency} {totalPayable.toFixed(2)}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12">
                            {/* Sidebar */}
                            <div className="lg:col-span-4 bg-slate-50 p-6 border-b lg:border-r border-slate-200 flex flex-col gap-6">
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Staff Name</label>
                                    <input type="text" value={state.staffName} onChange={(e) => updateState('staffName', e.target.value)} 
                                        placeholder="Name" className="w-full p-3 border rounded-lg outline-none focus:border-indigo-500" />
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Settings</label>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-4">
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => updateState('payMode', 'daily')} className={`py-2 text-xs font-bold rounded ${state.payMode==='daily'?'bg-indigo-500 text-white':'bg-slate-200'}`}>Daily Rate</button>
                                            <button onClick={() => updateState('payMode', 'fixed')} className={`py-2 text-xs font-bold rounded ${state.payMode==='fixed'?'bg-indigo-500 text-white':'bg-slate-200'}`}>Fixed Total</button>
                                        </div>
                                        <div className="relative">
                                            <span className="absolute left-3 top-2 text-slate-400 font-bold">{currency}</span>
                                            <input type="number" value={state.rateInput} onChange={(e) => updateState('rateInput', parseFloat(e.target.value)||0)} 
                                                className="w-full pl-8 p-2 border rounded outline-none" />
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="text-[10px] text-slate-400 uppercase block">Start Date</label>
                                                <input type="date" value={state.startDate} onChange={(e) => handleDateRangeChange('start', e.target.value)} className="w-full p-1 border rounded text-sm" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-slate-400 uppercase block">End Date</label>
                                                <input type="date" value={state.endDate} onChange={(e) => handleDateRangeChange('end', e.target.value)} className="w-full p-1 border rounded text-sm" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex flex-col gap-2 mt-auto">
                                    <button onClick={() => generatePDF(null)} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow flex justify-center gap-2 text-sm">
                                        Download Current PDF
                                    </button>
                                    {/* HISTORY BUTTON */}
                                    <button onClick={saveToHistory} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow flex justify-center gap-2 text-sm">
                                        Save & Start New
                                    </button>
                                </div>
                            </div>

                            {/* Main Grid */}
                            <div className="lg:col-span-8 p-6 bg-white">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <h3 className="font-bold text-lg text-slate-700">Attendance Log</h3>
                                        <div className="text-xs text-slate-400">{state.daysCount} Days Period</div>
                                    </div>
                                    
                                    {/* NEW: Quick Toggle Buttons */}
                                    <div className="flex gap-2">
                                        <button onClick={() => setAllAttendance(true)} className="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-lg hover:bg-emerald-200 transition">
                                            Mark All Present
                                        </button>
                                        <button onClick={() => setAllAttendance(false)} className="text-[10px] font-bold bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-200 transition">
                                            Reset
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 max-h-[400px] overflow-y-auto pr-2">
                                    {state.attendance.map((p, i) => (
                                        <button key={i} onClick={() => toggleDay(i)} 
                                            className={`p-2 rounded-lg border text-left transition-all ${p ? 'border-emerald-400 bg-emerald-50' : 'border-slate-200 bg-slate-50 opacity-60'}`}>
                                            <div className="flex justify-between text-[10px] text-slate-400 font-bold mb-1">
                                                <span>DAY {i+1}</span>
                                                {p && <span className="w-2 h-2 rounded-full bg-emerald-500"></span>}
                                            </div>
                                            <div className="text-xs font-bold text-slate-700">{getDisplayDate(state.startDate, i)}</div>
                                            <div className={`text-[10px] mt-1 font-bold ${p ? 'text-emerald-600' : 'text-slate-400'}`}>
                                                {p ? `+${currency}${dailyRate.toFixed(0)}` : 'Absent'}
                                            </div>
                                        </button>
                                    ))}
                                </div>

                                {/* HISTORY SECTION */}
                                {state.history && state.history.length > 0 && (
                                    <div className="mt-8 pt-6 border-t border-slate-100">
                                        <h3 className="font-bold text-slate-700 mb-3">Past Cut-off Logs</h3>
                                        <div className="space-y-2 max-h-[200px] overflow-y-auto">
                                            {state.history.map((h) => (
                                                <div key={h.id} className="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100 text-sm">
                                                    <div>
                                                        <div className="font-bold text-slate-700">{h.staffName}</div>
                                                        <div className="text-xs text-slate-500">{formatFullDate(h.startDate)} - {formatFullDate(h.endDate)}</div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-bold text-green-600">{currency}{h.totalPayable.toFixed(2)}</span>
                                                        <button onClick={() => generatePDF(h)} className="text-xs bg-white border border-blue-200 text-blue-600 px-2 py-1 rounded hover:bg-blue-50">PDF</button>
                                                        <button onClick={() => deleteHistoryItem(h.id)} className="text-xs text-red-400 hover:text-red-600">Ã—</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
