<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance and Payslip Generator</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Load Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const currency = '₱'; 
        
        // =========================================================
        // FIREBASE CONFIGURATION
        // =========================================================
        const userFirebaseConfig = {
             apiKey: "AIzaSyBK94w1LslQlZpowcEytMWI20iUbXQYBv4",
             authDomain: "payslip-6e83f.firebaseapp.com",
             projectId: "payslip-6e83f",
             storageBucket: "payslip-6e83f.firebasestorage.app",
             messagingSenderId: "804926507342",
             appId: "1:804926507342:web:f0c3b19786574d18ab761f",
             measurementId: "G-TJE0RCHW4P"
        };

        const FIREBASE_ENABLED = userFirebaseConfig.projectId && userFirebaseConfig.apiKey;
        const LOCAL_STORAGE_KEY = 'payslip_generator_v5_multi_restdays';
        
        // Dates
        const today = new Date();
        const initialEnd = new Date(today);
        initialEnd.setDate(today.getDate() + 14); 

        // --- CORE STATE ---
        const DEFAULT_STATE = {
            startDate: today.toISOString().substr(0, 10), 
            endDate: initialEnd.toISOString().substr(0, 10),
            daysCount: 15,
            staff: [
                { id: 1, name: "Staff 1", rate: 500, payMode: 'daily', attendance: Array(15).fill(false) }
            ]
        };

        // --- HELPERS ---
        const showMessageBox = (message, type = 'info') => {
            const box = document.getElementById('message-box');
            if (!box) return;
            box.textContent = message;
            box.className = `fixed top-4 right-4 p-3 px-4 rounded-xl shadow-2xl text-sm z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 4000);
        };

        // Helper to calculate specific date details
        const getDateDetails = (startStr, offset) => {
            const d = new Date(startStr);
            d.setDate(d.getDate() + offset);
            return {
                dayName: d.toLocaleDateString('en-US', { weekday: 'short' }), // Mon, Tue
                monthDay: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), // Nov 19
                fullDate: d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', weekday: 'short' })
            };
        };

        // Helper to check if a specific day index is Sat (6) or Sun (0)
        const isWeekend = (startStr, offset) => {
            const d = new Date(startStr);
            d.setDate(d.getDate() + offset);
            const day = d.getDay();
            return day === 0 || day === 6;
        };

        const formatFullDate = (dateStr) => new Date(dateStr).toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });

        // --- DATA SYNC ---
        const loadLocalData = () => {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                return stored ? JSON.parse(stored) : DEFAULT_STATE;
            } catch (e) { return DEFAULT_STATE; }
        };

        const saveLocalData = (data) => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));

        let db, userId;
        const PAYSLIP_COLLECTION = 'payslips';
        const PAYSLIP_DOC_ID = 'staff_data_v4_multi'; 

        const writeToFirestore = (data) => {
            if (!db || !userId) return;
            const docRef = window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID);
            window.setDoc(docRef, data, { merge: true })
                .then(() => showMessageBox("Synced!"))
                .catch(e => console.error(e));
        };

        // --- COMPONENT ---
        function App() {
            const [state, setState] = useState(DEFAULT_STATE);
            const [isSaving, setIsSaving] = useState(false);
            const [isCloudMode, setIsCloudMode] = useState(false);
            const [isDataReady, setIsDataReady] = useState(false);
            const isInitialLoad = useRef(true);

            // Firebase Init
            useEffect(() => {
                if (FIREBASE_ENABLED && window.getFirestore) {
                    try {
                        const app = window.initializeApp(userFirebaseConfig);
                        const auth = window.getAuth(app);
                        db = window.getFirestore(app);
                        window.onAuthStateChanged(auth, u => {
                            if (u) { userId = u.uid; setIsCloudMode(true); }
                            else window.signInAnonymously(auth).catch(() => fallbackToLocal());
                        });
                    } catch (e) { fallbackToLocal(); }
                } else fallbackToLocal();
            }, []);

            const fallbackToLocal = () => {
                setIsCloudMode(false); setIsDataReady(true); setState(loadLocalData());
            };

            // Listener
            useEffect(() => {
                if (!isCloudMode || !db) return;
                const unsub = window.onSnapshot(window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID), (snap) => {
                    if (snap.exists()) {
                        setState(snap.data());
                        if (!isDataReady) { showMessageBox("Cloud Data Loaded!"); setIsDataReady(true); }
                    } else if (!isDataReady) setIsDataReady(true);
                });
                return () => unsub();
            }, [isCloudMode, isDataReady]);

            // Save
            useEffect(() => {
                if (!isDataReady || isInitialLoad.current) { isInitialLoad.current = false; return; }
                setIsSaving(true);
                const t = setTimeout(() => {
                    isCloudMode ? writeToFirestore(state) : saveLocalData(state);
                    setIsSaving(false);
                }, 800);
                return () => clearTimeout(t);
            }, [state, isCloudMode, isDataReady]);

            // --- ACTIONS ---
            const updateGlobalDate = (type, val) => {
                let start = type === 'start' ? new Date(val) : new Date(state.startDate);
                let end = type === 'end' ? new Date(val) : new Date(state.endDate);
                if (end < start) { type === 'start' ? end = new Date(start) : start = new Date(end); }
                
                const diffDays = Math.ceil(Math.abs(end - start) / (86400000)) + 1;
                
                const newStaff = state.staff.map(s => ({
                    ...s,
                    attendance: Array(diffDays).fill(false).map((v, i) => i < s.attendance.length ? s.attendance[i] : false)
                }));

                setState(p => ({ 
                    ...p, 
                    startDate: start.toISOString().substr(0,10), 
                    endDate: end.toISOString().substr(0,10), 
                    daysCount: diffDays,
                    staff: newStaff
                }));
            };

            const addStaff = () => {
                const newId = Date.now();
                setState(p => ({
                    ...p,
                    staff: [...p.staff, { id: newId, name: "New Staff", rate: 500, payMode: 'daily', attendance: Array(p.daysCount).fill(false) }]
                }));
            };

            const secureRemoveStaff = (id, name) => {
                const input = prompt(`SECURITY CHECK:\n\nTo delete staff member "${name}", please type the word: DELETE`);
                if (input === 'DELETE') {
                    setState(p => ({ ...p, staff: p.staff.filter(s => s.id !== id) }));
                    showMessageBox("Staff member deleted.");
                }
            };

            const updateStaff = (id, field, val) => {
                setState(p => ({
                    ...p,
                    staff: p.staff.map(s => s.id === id ? { ...s, [field]: val } : s)
                }));
            };

            const toggleAttendance = (staffId, dayIndex) => {
                if (isWeekend(state.startDate, dayIndex)) return;

                setState(p => ({
                    ...p,
                    staff: p.staff.map(s => {
                        if(s.id !== staffId) return s;
                        const newAtt = [...s.attendance];
                        newAtt[dayIndex] = !newAtt[dayIndex];
                        return { ...s, attendance: newAtt };
                    })
                }));
            };

            const markAllStaff = (isPresent) => {
                if(confirm(`Are you sure you want to mark ALL staff as ${isPresent ? 'PRESENT' : 'ABSENT'} (excluding weekends)?`)) {
                    setState(p => ({
                        ...p,
                        staff: p.staff.map(s => ({ 
                            ...s, 
                            attendance: s.attendance.map((val, i) => {
                                if (isWeekend(p.startDate, i)) return false;
                                return isPresent;
                            })
                        }))
                    }));
                }
            };

            const secureReset = () => {
                const input = prompt("Type RESET to clear ALL data for ALL staff:");
                if(input === 'RESET') {
                    setState(p => ({
                        ...p,
                        staff: p.staff.map(s => ({ ...s, attendance: Array(p.daysCount).fill(false) }))
                    }));
                    showMessageBox("All records cleared.");
                }
            };

            const calculatePay = (s) => {
                const present = s.attendance.filter(Boolean).length;
                let total = 0;
                if(s.payMode === 'daily') total = (parseFloat(s.rate)||0) * present;
                else {
                    const fixed = parseFloat(s.rate)||0;
                    const daily = state.daysCount > 0 ? fixed / state.daysCount : 0;
                    total = daily * present;
                }
                return { present, total };
            };

            const generatePDF = (s) => {
                if(!s.name) return alert("Enter name first");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const { present, total } = calculatePay(s);
                const dailyRate = s.payMode === 'daily' ? s.rate : (s.rate / state.daysCount);

                doc.setFillColor(30, 41, 59); // Slate 800 (Dark Theme)
                doc.rect(0,0,210,40,'F');
                doc.setTextColor(255); doc.setFontSize(22);
                doc.text("Attendance and Payslip Generator", 105, 20, {align:'center'});
                doc.setFontSize(12);
                doc.text(`Period: ${formatFullDate(state.startDate)} - ${formatFullDate(state.endDate)}`, 105, 30, {align:'center'});

                doc.setTextColor(0); doc.setFontSize(14);
                doc.text(`Name: ${s.name}`, 20, 60);
                doc.text(`Rate: ${currency}${s.rate} (${s.payMode})`, 20, 70);

                doc.setDrawColor(0); doc.rect(120, 55, 70, 30);
                doc.setFontSize(10); doc.text("Net Payable:", 125, 65);
                doc.setFontSize(18); doc.setTextColor(22, 163, 74);
                doc.text(`${currency}${total.toFixed(2)}`, 125, 78);

                let y = 100;
                doc.setTextColor(0); doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text("Attendance Log", 20, y); y+=10;
                
                doc.setFontSize(10); doc.setFillColor(240); doc.rect(20, y-5, 170, 8, 'F');
                doc.text("Date", 25, y); doc.text("Status", 100, y); doc.text("Value", 160, y);
                y+=10; doc.setFont(undefined, 'normal');

                s.attendance.forEach((p, i) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    // PDF Date Display
                    const { fullDate } = getDateDetails(state.startDate, i);
                    doc.text(fullDate, 25, y);
                    
                    if (isWeekend(state.startDate, i)) {
                        doc.setTextColor(249, 115, 22); 
                        doc.text("Rest Day", 100, y);
                        doc.setTextColor(150);
                        doc.text("-", 160, y);
                    } else {
                        if (p) doc.setTextColor(22, 163, 74); else doc.setTextColor(150);
                        doc.text(p ? "Present" : "Absent", 100, y);
                        doc.setTextColor(0);
                        doc.text(p ? `${currency}${dailyRate.toFixed(2)}` : "-", 160, y);
                    }
                    y+=8;
                });

                doc.save(`${s.name}_payslip.pdf`);
            };

            if (!isDataReady) return <div className="flex h-screen items-center justify-center text-slate-600 font-bold">Loading Multi-Staff System...</div>;

            return (
                <div className="min-h-screen pb-20">
                    <div id="message-box" className="hidden"></div>
                    
                    {/* TOP BAR - THEME COLOR UPDATED TO SLATE-800 */}
                    <div className="bg-slate-800 text-white p-4 sticky top-0 z-20 shadow-lg">
                        <div className="max-w-5xl mx-auto">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    Attendance and Payslip Generator
                                </h1>
                                {/* Darker Slate Input Container */}
                                <div className="flex gap-2 bg-slate-900 p-1 rounded-lg">
                                    <input type="date" value={state.startDate} onChange={(e)=>updateGlobalDate('start', e.target.value)} className="text-black text-xs p-2 rounded" />
                                    <span className="flex items-center text-xs">to</span>
                                    <input type="date" value={state.endDate} onChange={(e)=>updateGlobalDate('end', e.target.value)} className="text-black text-xs p-2 rounded" />
                                    <div className="flex items-center px-3 text-xs font-bold bg-slate-600 rounded">
                                        {state.daysCount} Days
                                    </div>
                                </div>
                            </div>

                            {/* BULK TOOLS - BUTTON COLORS UPDATED */}
                            <div className="flex gap-2 overflow-x-auto pb-1">
                                <button onClick={addStaff} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-xs font-bold flex items-center gap-1 whitespace-nowrap">
                                    + Add Staff
                                </button>
                                <div className="h-8 w-px bg-slate-600 mx-2"></div>
                                <button onClick={()=>markAllStaff(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs whitespace-nowrap">Mark ALL Present</button>
                                <button onClick={()=>markAllStaff(false)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs whitespace-nowrap">Mark ALL Absent</button>
                                <button onClick={secureReset} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs ml-auto whitespace-nowrap">Reset ALL Data</button>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="max-w-5xl mx-auto p-4 space-y-6">
                        
                        {state.staff.map((s) => {
                            const { present, total } = calculatePay(s);
                            return (
                                <div key={s.id} className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                                    {/* Staff Header */}
                                    <div className="bg-slate-50 p-4 border-b border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <div className="flex gap-3 w-full md:w-auto items-center">
                                            <input type="text" value={s.name} onChange={(e)=>updateStaff(s.id, 'name', e.target.value)} 
                                                className="font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none w-full md:w-48" placeholder="Staff Name" />
                                            
                                            <button onClick={()=>secureRemoveStaff(s.id, s.name)} className="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1 rounded text-xs font-bold transition-colors">
                                                Delete
                                            </button>
                                        </div>
                                        
                                        <div className="flex flex-wrap items-center gap-2 w-full md:w-auto">
                                            <div className="flex bg-white border rounded overflow-hidden">
                                                {/* Button Active States updated to BLUE */}
                                                <button onClick={()=>updateStaff(s.id, 'payMode', 'daily')} className={`px-3 py-1 text-[10px] font-bold ${s.payMode==='daily'?'bg-blue-600 text-white':'bg-slate-100'}`}>Daily</button>
                                                <button onClick={()=>updateStaff(s.id, 'payMode', 'fixed')} className={`px-3 py-1 text-[10px] font-bold ${s.payMode==='fixed'?'bg-blue-600 text-white':'bg-slate-100'}`}>Fixed</button>
                                            </div>
                                            <div className="relative w-24">
                                                <span className="absolute left-2 top-1.5 text-slate-400 text-xs">₱</span>
                                                <input type="number" value={s.rate} onChange={(e)=>updateStaff(s.id, 'rate', e.target.value)} 
                                                    className="w-full pl-5 p-1 border rounded text-sm focus:border-blue-500 outline-none" />
                                            </div>
                                            <div className="bg-green-100 text-green-800 px-3 py-1 rounded text-sm font-bold">
                                                Total: {currency}{total.toFixed(0)}
                                            </div>
                                            <button onClick={()=>generatePDF(s)} className="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700">
                                                PDF
                                            </button>
                                        </div>
                                    </div>

                                    {/* Attendance Grid */}
                                    <div className="p-4">
                                        <div className="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-15 gap-1">
                                            {s.attendance.map((isPresent, idx) => {
                                                const isRestDay = isWeekend(state.startDate, idx);
                                                const { dayName, monthDay } = getDateDetails(state.startDate, idx);

                                                return (
                                                    <button key={idx} onClick={()=>toggleAttendance(s.id, idx)} disabled={isRestDay}
                                                        // Increased height from h-12 to h-16 and adjusted text size
                                                        className={`h-16 flex flex-col items-center justify-center rounded border transition-all p-1
                                                        ${isRestDay 
                                                            ? 'bg-orange-50 border-orange-200 text-orange-400 cursor-not-allowed opacity-70' 
                                                            : (isPresent ? 'bg-green-500 border-green-600 text-white' : 'bg-slate-100 border-slate-200 text-slate-400')
                                                        }`}>
                                                        {/* Adjusted font sizes for clarity */}
                                                        <span className="opacity-70 text-[10px] uppercase">{dayName}</span>
                                                        <span className="font-bold text-sm">
                                                            {isRestDay ? "REST" : monthDay}
                                                        </span>
                                                    </button>
                                                )
                                            })}
                                        </div>
                                        <div className="mt-2 text-right text-xs text-slate-400">
                                            {present} days present
                                        </div>
                                    </div>
                                </div>
                            )
                        })}

                        {state.staff.length === 0 && (
                            <div className="text-center py-10 text-slate-400 bg-white rounded-xl border-dashed border-2">
                                No staff members. Click "Add Staff" to begin.
                            </div>
                        )}
                    </div>

                    {/* Saving Indicator updated to Blue */}
                    {isSaving && <div className="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-full text-xs shadow-lg animate-pulse">Saving...</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
