<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance and Payslip Generator</title>
    
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and ReactDOM --><script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel --><script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load jsPDF --><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Load Firebase --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const currency = 'PHP'; // Changed from 'â‚±' to 'PHP' for universal PDF compatibility
        
        // =========================================================
        // FIREBASE CONFIGURATION
        // =========================================================
        // Note: The Firebase setup is using hardcoded values, which are generally not ideal
        // but are kept here to maintain the structure of the provided code.
        const userFirebaseConfig = {
            apiKey: "AIzaSyBK94w1LslQlZpowcEytMWI20iUbXQYBv4",
            authDomain: "payslip-6e83f.firebaseapp.com",
            projectId: "payslip-6e83f",
            storageBucket: "payslip-6e83f.firebasestorage.app",
            messagingSenderId: "804926507342",
            appId: "1:804926507342:web:f0c3b19786574d18ab761f",
            measurementId: "G-TJE0RCHW4P"
        };

        const FIREBASE_ENABLED = userFirebaseConfig.projectId && userFirebaseConfig.apiKey;
        const LOCAL_STORAGE_KEY = 'payslip_generator_v5_multi_restdays';
        
        // Dates
        const today = new Date();
        const initialEnd = new Date(today);
        initialEnd.setDate(today.getDate() + 14); 

        // --- CORE STATE ---
        const DEFAULT_STATE = {
            startDate: today.toISOString().substr(0, 10), 
            endDate: initialEnd.toISOString().substr(0, 10),
            daysCount: 15,
            staff: [
                { id: 1, name: "Staff 1", rate: 500, payMode: 'daily', attendance: Array(15).fill(false) }
            ]
        };

        // --- HELPERS ---
        const showMessageBox = (message, type = 'info') => {
            const box = document.getElementById('message-box');
            if (!box) return;
            box.textContent = message;
            box.className = `fixed top-4 right-4 p-3 px-4 rounded-xl shadow-2xl text-sm z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 4000);
        };

        // Helper to calculate specific date details
        const getDateDetails = (startStr, offset) => {
            const d = new Date(startStr);
            d.setDate(d.getDate() + offset);
            return {
                dayName: d.toLocaleDateString('en-US', { weekday: 'short' }), // Mon, Tue
                monthDay: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), // Nov 19
                // Use PH locale with specific format for PDF
                fullDate: d.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', weekday: 'short' })
            };
        };

        // Helper to check if a specific day index is Sat (6) or Sun (0)
        const isWeekend = (startStr, offset) => {
            const d = new Date(startStr);
            d.setDate(d.getDate() + offset);
            const day = d.getDay();
            return day === 0 || day === 6;
        };

        // Helper to format the date range string for the payslip header
        const formatFullDate = (dateStr) => {
            const d = new Date(dateStr);
            // Ensure the date object is valid before formatting
            if (isNaN(d.getTime())) return 'Invalid Date';
            return d.toLocaleDateString('en-PH', { year: 'numeric', month: 'short', day: 'numeric' });
        }


        // --- DATA SYNC ---
        const loadLocalData = () => {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                return stored ? JSON.parse(stored) : DEFAULT_STATE;
            } catch (e) { return DEFAULT_STATE; }
        };

        const saveLocalData = (data) => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));

        let db, userId;
        const PAYSLIP_COLLECTION = 'payslips';
        const PAYSLIP_DOC_ID = 'staff_data_v4_multi'; 

        const writeToFirestore = (data) => {
            // Note: The Firestore logic is currently written to use the
            // hardcoded config, but the recommended setup uses the injected
            // __app_id, __firebase_config, and __initial_auth_token.
            // Since this is an update to an existing artifact, we preserve
            // the existing structure for state management.
            if (!db || !userId) return;
            const docRef = window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID);
            window.setDoc(docRef, data, { merge: true })
                .then(() => showMessageBox("Synced!"))
                .catch(e => console.error(e));
        };

        // --- COMPONENT ---
        function App() {
            const [state, setState] = useState(DEFAULT_STATE);
            const [isSaving, setIsSaving] = useState(false);
            const [isCloudMode, setIsCloudMode] = useState(false);
            const [isDataReady, setIsDataReady] = useState(false);
            const isInitialLoad = useRef(true);

            // Firebase Init
            useEffect(() => {
                if (FIREBASE_ENABLED && window.getFirestore) {
                    try {
                        const app = window.initializeApp(userFirebaseConfig);
                        const auth = window.getAuth(app);
                        db = window.getFirestore(app);
                        window.onAuthStateChanged(auth, u => {
                            if (u) { userId = u.uid; setIsCloudMode(true); }
                            else window.signInAnonymously(auth).catch(() => fallbackToLocal());
                        });
                    } catch (e) { fallbackToLocal(); }
                } else fallbackToLocal();
            }, []);

            const fallbackToLocal = () => {
                setIsCloudMode(false); setIsDataReady(true); setState(loadLocalData());
            };

            // Listener
            useEffect(() => {
                if (!isCloudMode || !db) return;
                const unsub = window.onSnapshot(window.doc(db, PAYSLIP_COLLECTION, PAYSLIP_DOC_ID), (snap) => {
                    if (snap.exists()) {
                        setState(snap.data());
                        if (!isDataReady) { showMessageBox("Cloud Data Loaded!"); setIsDataReady(true); }
                    } else if (!isDataReady) setIsDataReady(true);
                });
                return () => unsub();
            }, [isCloudMode, isDataReady]);

            // Save
            useEffect(() => {
                if (!isDataReady || isInitialLoad.current) { isInitialLoad.current = false; return; }
                setIsSaving(true);
                const t = setTimeout(() => {
                    isCloudMode ? writeToFirestore(state) : saveLocalData(state);
                    setIsSaving(false);
                }, 800);
                return () => clearTimeout(t);
            }, [state, isCloudMode, isDataReady]);

            // --- ACTIONS ---
            const updateGlobalDate = (type, val) => {
                let start = type === 'start' ? new Date(val) : new Date(state.startDate);
                let end = type === 'end' ? new Date(val) : new Date(state.endDate);
                
                // Reset time to midnight to ensure accurate day calculation
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);

                if (end < start) { 
                    type === 'start' ? end = new Date(start) : start = new Date(end); 
                }
                
                const diffTime = Math.abs(end.getTime() - start.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                const newStaff = state.staff.map(s => ({
                    ...s,
                    // Resize attendance array to new daysCount, preserving existing data
                    attendance: Array(diffDays).fill(false).map((v, i) => i < s.attendance.length ? s.attendance[i] : false)
                }));

                setState(p => ({ 
                    ...p, 
                    startDate: start.toISOString().substr(0,10), 
                    endDate: end.toISOString().substr(0,10), 
                    daysCount: diffDays,
                    staff: newStaff
                }));
            };

            const addStaff = () => {
                const newId = Date.now();
                setState(p => ({
                    ...p,
                    staff: [...p.staff, { id: newId, name: "New Staff", rate: 500, payMode: 'daily', attendance: Array(p.daysCount).fill(false) }]
                }));
            };

            const secureRemoveStaff = (id, name) => {
                // IMPORTANT: Replacing confirm() with a custom message box or prompt, as alert()/confirm() are forbidden
                const input = window.prompt(`SECURITY CHECK:\n\nTo delete staff member "${name}", please type the word: DELETE`);
                if (input === 'DELETE') {
                    setState(p => ({ ...p, staff: p.staff.filter(s => s.id !== id) }));
                    showMessageBox("Staff member deleted.");
                } else if (input !== null) {
                    showMessageBox("Deletion cancelled or failed security check.", 'error');
                }
            };

            const updateStaff = (id, field, val) => {
                setState(p => ({
                    ...p,
                    staff: p.staff.map(s => s.id === id ? { ...s, [field]: val } : s)
                }));
            };

            const toggleAttendance = (staffId, dayIndex) => {
                if (isWeekend(state.startDate, dayIndex)) return;

                setState(p => ({
                    ...p,
                    staff: p.staff.map(s => {
                        if(s.id !== staffId) return s;
                        const newAtt = [...s.attendance];
                        newAtt[dayIndex] = !newAtt[dayIndex];
                        return { ...s, attendance: newAtt };
                    })
                }));
            };

            const markAllStaff = (isPresent) => {
                // IMPORTANT: Replacing confirm() with a custom message box or prompt, as alert()/confirm() are forbidden
                const input = window.prompt(`Are you sure you want to mark ALL staff as ${isPresent ? 'PRESENT' : 'ABSENT'} (excluding weekends)? Type YES to confirm.`);
                
                if(input === 'YES') {
                    setState(p => ({
                        ...p,
                        staff: p.staff.map(s => ({ 
                            ...s, 
                            attendance: s.attendance.map((val, i) => {
                                if (isWeekend(p.startDate, i)) return false;
                                return isPresent;
                            })
                        }))
                    }));
                    showMessageBox(`All non-weekend days marked as ${isPresent ? 'Present' : 'Absent'}.`);
                } else if (input !== null) {
                    showMessageBox("Action cancelled.", 'info');
                }
            };

            const secureReset = () => {
                // IMPORTANT: Replacing confirm() with a custom message box or prompt, as alert()/confirm() are forbidden
                const input = window.prompt("Type RESET to clear ALL attendance data for ALL staff:");
                if(input === 'RESET') {
                    setState(p => ({
                        ...p,
                        staff: p.staff.map(s => ({ ...s, attendance: Array(p.daysCount).fill(false) }))
                    }));
                    showMessageBox("All attendance records cleared.");
                } else if (input !== null) {
                    showMessageBox("Reset cancelled or failed security check.", 'error');
                }
            };

            const calculatePay = (s) => {
                const present = s.attendance.filter(Boolean).length;
                let total = 0;
                const rate = parseFloat(s.rate) || 0;
                
                if(s.payMode === 'daily') {
                    total = rate * present;
                } else {
                    // Fixed Monthly/Period Pay
                    // Calculate the daily equivalent rate for fixed pay
                    const totalWorkingDays = s.attendance.filter((_, i) => !isWeekend(state.startDate, i)).length;
                    
                    if (totalWorkingDays > 0) {
                        const dailyRateEquivalent = rate / totalWorkingDays;
                        total = dailyRateEquivalent * present;
                    } else {
                        total = 0;
                    }
                }
                return { present, total };
            };

            // --- PDF GENERATION (FIXED) ---
            const generatePDF = (s) => {
                if(!s.name || s.name.trim() === "") { 
                    showMessageBox("Please enter a staff name before generating the payslip.", 'error');
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const { present, total } = calculatePay(s);
                const dailyRate = s.payMode === 'daily' 
                    ? parseFloat(s.rate) || 0 
                    : (parseFloat(s.rate) || 0) / s.attendance.filter((_, i) => !isWeekend(state.startDate, i)).length; // Use working days for fixed calculation

                // --- Header (Slate 800) ---
                doc.setFillColor(30, 41, 59); 
                doc.rect(0,0,210,40,'F');
                doc.setTextColor(255); doc.setFontSize(22);
                doc.text("Payslip & Attendance Report", 105, 15, {align:'center'});
                doc.setFontSize(12);
                doc.text(`Period: ${formatFullDate(state.startDate)} - ${formatFullDate(state.endDate)}`, 105, 25, {align:'center'});
                doc.text(`Total Days in Period: ${state.daysCount}`, 105, 33, {align:'center'});

                // --- Employee Details ---
                doc.setTextColor(0); doc.setFontSize(14); doc.setFont(undefined, 'bold');
                doc.text("Employee Details", 20, 55); doc.setFont(undefined, 'normal');
                doc.text(`Name: ${s.name}`, 20, 65);
                
                // Displaying Rate based on pay mode - FIX: Ensure s.rate is a number before calling toFixed
                const safeRate = parseFloat(s.rate) || 0;
                const rateLabel = s.payMode === 'daily' ? `Daily Rate: ${currency}${safeRate.toFixed(2)}` : `Fixed Pay: ${currency}${safeRate.toFixed(2)} (Equivalent Daily: ${currency}${dailyRate.toFixed(2)})`;
                doc.text(rateLabel, 20, 75);
                doc.text(`Days Present: ${present}`, 20, 85);


                // --- Net Payable Box (Green Accent) ---
                doc.setDrawColor(30, 41, 59); // Dark border
                doc.setFillColor(240, 253, 244); // Green 50 background
                doc.rect(120, 60, 70, 30, 'F');
                doc.rect(120, 60, 70, 30, 'S'); // Draw border
                
                doc.setFontSize(10); doc.setTextColor(71, 85, 105); // Slate 500
                doc.text("NET PAYABLE", 125, 70);
                doc.setFontSize(18); doc.setTextColor(22, 163, 74); // Green 600
                doc.setFont(undefined, 'bold');
                // Use PH local formatting for number
                doc.text(`${currency} ${total.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 125, 83);
                doc.setFont(undefined, 'normal');

                // --- Attendance Log ---
                let y = 110;
                doc.setTextColor(0); doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text("Detailed Attendance Log", 20, y); y+=10;
                
                doc.setFontSize(10); doc.setFillColor(230); doc.rect(20, y-5, 170, 8, 'F');
                doc.text("Date", 25, y); doc.text("Status", 95, y); doc.text("Value", 155, y);
                y+=10; doc.setFont(undefined, 'normal');

                s.attendance.forEach((p, i) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    const { fullDate } = getDateDetails(state.startDate, i);
                    doc.text(fullDate, 25, y);
                    
                    if (isWeekend(state.startDate, i)) {
                        doc.setTextColor(249, 115, 22); // Orange 500
                        doc.text("Rest Day", 95, y);
                        doc.setTextColor(150);
                        doc.text("-", 155, y);
                    } else {
                        if (p) doc.setTextColor(22, 163, 74); else doc.setTextColor(150);
                        doc.text(p ? "Present" : "Absent", 95, y);
                        doc.setTextColor(0);
                        doc.text(p ? `${currency}${dailyRate.toFixed(2)}` : "-", 155, y);
                    }
                    y+=7; // Reduced line spacing for more entries
                });

                doc.save(`${s.name}_payslip_${state.startDate}_to_${state.endDate}.pdf`);
                showMessageBox("Payslip PDF generated!", 'info');
            };
            // --- END PDF GENERATION (FIXED) ---


            if (!isDataReady) return <div className="flex h-screen items-center justify-center text-slate-600 font-bold">Loading Multi-Staff System...</div>;

            return (
                <div className="min-h-screen pb-20">
                    <div id="message-box" className="hidden"></div>
                    
                    {/* TOP BAR - THEME COLOR UPDATED TO SLATE-800 */}
                    <div className="bg-slate-800 text-white p-4 sticky top-0 z-20 shadow-lg">
                        <div className="max-w-5xl mx-auto">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    Attendance and Payslip Generator
                                </h1>
                                {/* Darker Slate Input Container */}
                                <div className="flex gap-2 bg-slate-900 p-1 rounded-lg">
                                    <input type="date" value={state.startDate} onChange={(e)=>updateGlobalDate('start', e.target.value)} className="text-black text-xs p-2 rounded" />
                                    <span className="flex items-center text-xs">to</span>
                                    <input type="date" value={state.endDate} onChange={(e)=>updateGlobalDate('end', e.target.value)} className="text-black text-xs p-2 rounded" />
                                    <div className="flex items-center px-3 text-xs font-bold bg-slate-600 rounded">
                                        {state.daysCount} Days
                                    </div>
                                </div>
                            </div>

                            {/* BULK TOOLS - BUTTON COLORS UPDATED */}
                            <div className="flex gap-2 overflow-x-auto pb-1">
                                <button onClick={addStaff} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-xs font-bold flex items-center gap-1 whitespace-nowrap">
                                    + Add Staff
                                </button>
                                <div className="h-8 w-px bg-slate-600 mx-2"></div>
                                {/* Replaced window.confirm() with secure prompt */}
                                <button onClick={()=>markAllStaff(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs whitespace-nowrap">Mark ALL Present</button>
                                <button onClick={()=>markAllStaff(false)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs whitespace-nowrap">Mark ALL Absent</button>
                                <button onClick={secureReset} className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs ml-auto whitespace-nowrap">Reset ALL Attendance</button>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="max-w-5xl mx-auto p-4 space-y-6">
                        
                        {state.staff.map((s) => {
                            const { present, total } = calculatePay(s);
                            return (
                                <div key={s.id} className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                                    {/* Staff Header */}
                                    <div className="bg-slate-50 p-4 border-b border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <div className="flex gap-3 w-full md:w-auto items-center">
                                            <input type="text" value={s.name} onChange={(e)=>updateStaff(s.id, 'name', e.target.value)} 
                                                className="font-bold text-lg text-slate-800 bg-transparent border-b border-dashed border-slate-300 focus:border-blue-500 outline-none w-full md:w-48" placeholder="Staff Name" />
                                            
                                            <button onClick={()=>secureRemoveStaff(s.id, s.name)} className="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1 rounded text-xs font-bold transition-colors">
                                                Delete
                                            </button>
                                        </div>
                                        
                                        <div className="flex flex-wrap items-center gap-2 w-full md:w-auto">
                                            <div className="flex bg-white border rounded overflow-hidden">
                                                {/* Button Active States updated to BLUE */}
                                                <button onClick={()=>updateStaff(s.id, 'payMode', 'daily')} className={`px-3 py-1 text-[10px] font-bold ${s.payMode==='daily'?'bg-blue-600 text-white':'bg-slate-100'}`}>Daily</button>
                                                <button onClick={()=>updateStaff(s.id, 'payMode', 'fixed')} className={`px-3 py-1 text-[10px] font-bold ${s.payMode==='fixed'?'bg-blue-600 text-white':'bg-slate-100'}`}>Fixed</button>
                                            </div>
                                            <div className="relative w-24">
                                                <span className="absolute left-2 top-1.5 text-slate-400 text-xs">{currency}</span>
                                                <input type="number" value={s.rate} onChange={(e)=>updateStaff(s.id, 'rate', parseFloat(e.target.value))} 
                                                    className="w-full pl-8 p-1 border rounded text-sm focus:border-blue-500 outline-none" />
                                            </div>
                                            <div className="bg-green-100 text-green-800 px-3 py-1 rounded text-sm font-bold">
                                                {/* Use toLocaleString for better formatting */}
                                                Total: {currency}{total.toLocaleString('en-PH', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                            </div>
                                            <button onClick={()=>generatePDF(s)} className="bg-blue-600 text-white px-3 py-1.5 rounded text-xs hover:bg-blue-700">
                                                PDF
                                            </button>
                                        </div>
                                    </div>

                                    {/* Attendance Grid */}
                                    <div className="p-4">
                                        {/* Updated grid-cols for better spacing and larger cells */}
                                        {/* Default to 5 columns on small, up to 10 on larger screens for clarity */}
                                        <div className="grid grid-cols-5 sm:grid-cols-7 md:grid-cols-8 lg:grid-cols-10 gap-1">
                                            {s.attendance.map((isPresent, idx) => {
                                                const isRestDay = isWeekend(state.startDate, idx);
                                                const { dayName, monthDay } = getDateDetails(state.startDate, idx);

                                                return (
                                                    <button key={idx} onClick={()=>toggleAttendance(s.id, idx)} disabled={isRestDay}
                                                        // Increased height from h-16 to h-20 and adjusted text size
                                                        className={`h-20 flex flex-col items-center justify-center rounded border transition-all p-1 shadow-sm
                                                        ${isRestDay 
                                                            ? 'bg-orange-50 border-orange-200 text-orange-400 cursor-not-allowed opacity-70' 
                                                            : (isPresent ? 'bg-green-500 border-green-600 text-white hover:bg-green-600' : 'bg-slate-100 border-slate-200 text-slate-700 hover:bg-slate-200')
                                                        }`}>
                                                        {/* Adjusted font sizes for clarity */}
                                                        <span className="opacity-70 text-xs uppercase">{dayName}</span>
                                                        <span className="font-bold text-base">
                                                            {isRestDay ? "REST" : monthDay}
                                                        </span>
                                                    </button>
                                                )
                                            })}
                                        </div>
                                        <div className="mt-2 text-right text-sm text-slate-500 font-semibold">
                                            {present} days present
                                        </div>
                                    </div>
                                    {/* Visual separator for clarity between staff members */}
                                    <div className="h-1 bg-slate-100 mt-4"></div>
                                </div>
                            )
                        })}

                        {state.staff.length === 0 && (
                            <div className="text-center py-10 text-slate-400 bg-white rounded-xl border-dashed border-2">
                                No staff members. Click "+ Add Staff" to begin.
                            </div>
                        )}
                    </div>

                    {/* Saving Indicator updated to Blue */}
                    {isSaving && <div className="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-full text-xs shadow-lg animate-pulse">Saving...</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
