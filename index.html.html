<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payslip Generator sa Lagum (Working)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and ReactDOM (Global Access) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; }
        button { touch-action: manipulation; }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.2rem;
            color: #1e40af;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="root"></div>

    <!-- 
        --- SCRIPT BLOCK 1: MODULE IMPORTS AND GLOBAL SETUP --- 
        This block loads all Firebase modules using native imports and initializes them. 
        It makes the necessary Firebase and React functions globally available for the Babel script.
    -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for the React component
        window.F_initializeApp = initializeApp;
        window.F_getAuth = getAuth;
        window.F_signInAnonymously = signInAnonymously;
        window.F_signInWithCustomToken = signInWithCustomToken;
        window.F_onAuthStateChanged = onAuthStateChanged;
        window.F_setPersistence = setPersistence;
        window.F_browserSessionPersistence = browserSessionPersistence;
        window.F_getFirestore = getFirestore;
        window.F_doc = doc;
        window.F_setDoc = setDoc;
        window.F_onSnapshot = onSnapshot;

        // --- GLOBAL FIREBASE/APP CONFIG ---
        window.firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.db = null;
        window.auth = null;
        window.isFirebaseAvailable = false;
        
        // Default initial state
        window.DEFAULT_PAYSLIP_STATE = {
            staffName: "",
            payMode: 'daily',
            rateInput: 500,
            startDate: new Date().toISOString().substr(0, 10),
            // Attendance is saved as a JSON string to ensure clean saving in Firestore
            attendance: JSON.stringify(Array(15).fill(true)), 
        };


        // Attempt to initialize Firebase services safely
        if (window.firebaseConfig) {
            try {
                const app = window.F_initializeApp(window.firebaseConfig);
                window.db = window.F_getFirestore(app);
                window.auth = window.F_getAuth(app);
                window.isFirebaseAvailable = true;
                console.log("Firebase services initialized successfully.");
            } catch (error) {
                console.error("Firebase initialization failed. Running in Local Mode.", error);
            }
        } else {
             console.warn("Firebase config not found. Running in Local Mode.");
        }
    </script>

    <!-- 
        --- SCRIPT BLOCK 2: REACT COMPONENT WITH BABEL/JSX --- 
        This block uses type="text/babel" so the JSX syntax can be transformed. 
        It relies on the global variables set in the module script above.
    -->
    <script type="text/babel">
        // Access global React functions
        const { useState, useEffect, useRef } = React;
        const { doc, setDoc, onSnapshot, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore } = window; // Destructure if needed, but we'll use F_ prefixes

        // --- REACT COMPONENT ---

        function App() {
            // Firebase State
            const isCloudEnabled = window.isFirebaseAvailable;
            const [userId, setUserId] = useState(isCloudEnabled ? null : 'local-user');
            const [isLoading, setIsLoading] = useState(isCloudEnabled); // Only show loading if Firebase is expected to connect
            const [isSaving, setIsSaving] = useState(false);
            const [isCloudMode, setIsCloudMode] = useState(isCloudEnabled);

            // Payslip Data State
            // Use JSON.parse(attendance) for initial load if necessary
            const initialData = {
                ...window.DEFAULT_PAYSLIP_STATE,
                attendance: JSON.parse(window.DEFAULT_PAYSLIP_STATE.attendance) 
            };
            const [payslipData, setPayslipData] = useState(initialData);
            const currency = 'â‚±'; 
            
            // Ref to prevent initial save trigger before data is loaded/initialized
            const isInitialLoad = useRef(true); 
            const db = window.db;
            const auth = window.auth;

            // --- FIREBASE INITIALIZATION & AUTH (Only if available) ---
            useEffect(() => {
                if (!isCloudMode || !auth) {
                    setIsLoading(false); // If not cloud mode, we are done loading.
                    return;
                }

                const authenticate = async () => {
                    await window.F_setPersistence(auth, window.F_browserSessionPersistence);
                    try {
                        if (window.initialAuthToken) {
                            await window.F_signInWithCustomToken(auth, window.initialAuthToken);
                        } else {
                            await window.F_signInAnonymously(auth);
                        }
                        console.log("Authentication successful.");
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        // Fallback sign-in attempt
                        try {
                             await window.F_signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                        }
                    }
                };

                authenticate();
                
                // Auth State Listener: sets the userId once sign-in is complete
                const unsubscribeAuth = window.F_onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null); 
                        setIsLoading(false);
                        console.warn("User not authenticated.");
                    }
                });

                return () => unsubscribeAuth();
            }, [isCloudMode]); // Run only once on mount if in cloud mode

            // --- FIRESTORE DATA LISTENER (Only if in cloud mode) ---
            useEffect(() => {
                if (!isCloudMode || !userId || !db) return;

                const docPath = `artifacts/${window.appId}/users/${userId}/payslipData/currentSheet`;
                const payslipDocRef = window.F_doc(db, docPath);

                setIsLoading(true);

                const unsubscribeSnapshot = window.F_onSnapshot(payslipDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        
                        let loadedAttendance = data.attendance;
                        if (typeof loadedAttendance === 'string') {
                            try {
                                loadedAttendance = JSON.parse(loadedAttendance);
                            } catch (e) {
                                console.error("Failed to parse attendance string:", e);
                                loadedAttendance = [];
                            }
                        }
                        setPayslipData({ ...window.DEFAULT_PAYSLIP_STATE, ...data, attendance: loadedAttendance });
                        console.log("Data loaded from cloud.");
                    } else {
                        // If document doesn't exist, create it with default values
                        saveData(initialData); 
                        console.log("New document created in cloud.");
                    }
                    setIsLoading(false);
                    isInitialLoad.current = false;
                }, (error) => {
                    console.error("Error reading Firestore document, switching to Local Mode:", error);
                    setIsLoading(false);
                    setIsCloudMode(false); // Fallback if listener fails
                    showMessageBox("Error reading data. Switched to Local Mode.", 'error');
                });

                return () => unsubscribeSnapshot();
            }, [userId, isCloudMode]);

            // --- FIRESTORE DATA SAVER (Only if in cloud mode) ---
            const saveData = async (dataToSave = payslipData) => {
                if (!isCloudMode || !userId || !db) {
                    // In local mode, we don't save to cloud
                    return;
                }
                
                setIsSaving(true);
                const docPath = `artifacts/${window.appId}/users/${userId}/payslipData/currentSheet`;
                const payslipDocRef = window.F_doc(db, docPath);

                let currentAttendance = Array.isArray(dataToSave.attendance) ? dataToSave.attendance : JSON.parse(dataToSave.attendance || '[]');
                
                const dataToStore = {
                    ...dataToSave,
                    attendance: JSON.stringify(currentAttendance) // Store array as JSON string
                };

                try {
                    await window.F_setDoc(payslipDocRef, dataToStore, { merge: true });
                    showMessageBox("Data synchronized to the cloud!");
                } catch (error) {
                    console.error("Error writing document, switching to Local Mode:", error);
                    showMessageBox("Error saving data. Switched to Local Mode.", 'error');
                    setIsCloudMode(false); // Permanent switch to local mode on write failure
                } finally {
                    setIsSaving(false);
                }
            };

            // Debounced effect for saving data (triggers only after user stops typing/clicking)
            useEffect(() => {
                if (isInitialLoad.current && isCloudMode) return; // Skip save on initial load if we're waiting for cloud data

                const timeoutId = setTimeout(() => {
                    if (!isLoading) { 
                         saveData();
                    }
                }, 500); // Debounce by 500ms 

                return () => clearTimeout(timeoutId);
            }, [payslipData]); // Dependencies for saving

            // Helper to update state and trigger save
            const updatePayslipData = (key, value) => {
                setPayslipData(prev => ({
                    ...prev,
                    [key]: value
                }));
            };

            // --- CALCULATIONS & HANDLERS ---
            const { payMode, rateInput, startDate } = payslipData;
            
            // Ensure attendance is always an array for calculations
            const attendance = Array.isArray(payslipData.attendance) ? payslipData.attendance : [];
            
            const totalDays = 15;
            const daysPresent = attendance.filter(Boolean).length;
            const daysAbsent = totalDays - daysPresent;

            const getCalculatedValues = () => {
                let dailyRate = 0;
                let totalPayable = 0;

                if (payMode === 'daily') {
                    dailyRate = parseFloat(rateInput) || 0;
                    totalPayable = dailyRate * daysPresent;
                } else {
                    const totalFixed = parseFloat(rateInput) || 0;
                    dailyRate = totalDays > 0 ? totalFixed / totalDays : 0;
                    totalPayable = dailyRate * daysPresent;
                }

                return { dailyRate, totalPayable };
            };

            const { dailyRate, totalPayable } = getCalculatedValues();

            const getDisplayDate = (dayIndex) => {
                const date = new Date(startDate);
                date.setDate(date.getDate() + dayIndex);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });
            };

            const toggleDay = (index) => {
                const newAttendance = [...attendance];
                newAttendance[index] = !newAttendance[index];
                updatePayslipData('attendance', newAttendance);
            };

            const resetAttendance = () => {
                const isConfirmed = window.prompt("Type 'RESET' to confirm resetting all days to Present (This cannot be undone):");
                if (isConfirmed && isConfirmed.toUpperCase() === 'RESET') {
                    updatePayslipData('attendance', Array(15).fill(true));
                }
            };

            // Custom Message Box Function
            const showMessageBox = (message, type = 'info') => {
                const messageContainer = document.getElementById('message-box');
                if (!messageContainer) return;
                
                messageContainer.textContent = message;
                messageContainer.classList.remove('hidden', 'opacity-0');
                messageContainer.classList.add('opacity-100');

                // Clear previous classes and set new ones
                messageContainer.className = `fixed top-4 right-4 p-3 px-4 rounded-xl shadow-2xl text-sm z-50 transition-all duration-300 transform translate-y-0 opacity-100 
                                              ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white`;
                
                setTimeout(() => {
                    messageContainer.classList.remove('opacity-100');
                    messageContainer.classList.add('opacity-0');
                    setTimeout(() => messageContainer.classList.add('hidden'), 300);
                }, 4000);
            };


            // --- PDF GENERATION LOGIC ---
            const generatePDF = () => {
                if (!payslipData.staffName.trim()) {
                    const nameInputContainer = document.getElementById('name-input-container');
                    if (nameInputContainer) {
                         nameInputContainer.classList.add('ring-2', 'ring-red-500');
                        setTimeout(() => {
                            nameInputContainer.classList.remove('ring-2', 'ring-red-500');
                        }, 3000);
                    }
                    showMessageBox("Error: Please enter the Staff Name before generating the Payslip.", 'error');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const primaryColor = [34, 139, 34]; 

                // Header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.text("Payslip Generator sa Lagum Report", 105, 20, { align: "center" });
                doc.setFontSize(12);
                doc.text("15-Day Payment Period Summary", 105, 30, { align: "center" });

                // Staff Details
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.text(`Staff Name: ${payslipData.staffName}`, 20, 60);
                doc.setFontSize(11);
                doc.text(`Start Date: ${getDisplayDate(0)}`, 20, 70);
                doc.text(`End Date: ${getDisplayDate(14)}`, 20, 78);

                // Financial Summary Box
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.1);
                doc.rect(120, 55, 70, 35);
                
                doc.setFontSize(10);
                doc.text("Total Payable Amount (PHP):", 125, 65);
                doc.setFontSize(18);
                doc.setTextColor(34, 139, 34);
                doc.text(`${currency} ${totalPayable.toFixed(2)}`, 125, 75);
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`(Based on ${daysPresent} days present)`, 125, 82);

                // Table Header
                let yPos = 100;
                doc.setTextColor(0,0,0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("Attendance Breakdown", 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos-5, 170, 8, 'F');
                doc.text("Date", 25, yPos);
                doc.text("Status", 100, yPos);
                doc.text("Value", 160, yPos);

                // Table Rows
                yPos += 10;
                doc.setFont(undefined, 'normal');
                
                attendance.forEach((isPresent, index) => {
                    const dateStr = getDisplayDate(index);
                    const status = isPresent ? "Present" : "Absent";
                    const val = isPresent ? `${currency} ${dailyRate.toFixed(2)}` : "-";

                    if (yPos > 270) { 
                        doc.addPage();
                        yPos = 20;
                    }

                    doc.text(dateStr, 25, yPos);
                    
                    if (isPresent) {
                        doc.setTextColor(0, 128, 0); 
                    } else {
                        doc.setTextColor(200, 0, 0); 
                    }
                    doc.text(status, 100, yPos);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.text(val, 160, yPos);
                    
                    yPos += 8;
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                const modeText = isCloudMode ? "Cloud Sync Enabled" : "Running in Local Mode";
                doc.text(`Generated by Payslip Generator sa Lagum (${modeText})`, 105, 290, { align: "center" });

                // Save
                const safeName = payslipData.staffName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                doc.save(`${safeName}_payslip.pdf`);
            };

            if (isLoading && isCloudMode) {
                return (
                    <div className="loading-overlay">
                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Connecting to Cloud Database...
                    </div>
                );
            }

            return (
                <div className="min-h-screen p-4 md:p-8 font-sans text-gray-800 flex justify-center">
                    
                    {/* Floating Message Box */}
                    <div id="message-box" className="hidden fixed top-4 right-4 p-3 rounded-lg shadow-xl text-sm z-50 transition-opacity">
                        Data Synchronized!
                    </div>
                    {/* Saving Indicator */}
                    {isSaving && (
                        <div className="fixed bottom-4 right-4 bg-yellow-500 text-white p-2 px-4 rounded-full shadow-lg text-xs z-50">
                            Saving...
                        </div>
                    )}


                    <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
                        
                        {/* Top Header */}
                        <div className="bg-slate-800 p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <span className="text-3xl">ðŸ‡µðŸ‡­</span> Payslip Generator sa Lagum
                                </h1>
                                <p className="text-slate-400 text-sm">
                                    {isCloudMode ? "Cloud Sync Enabled" : "Running in Local Mode (No cloud save)"} 
                                    {isCloudMode && (
                                        <span className="ml-2 font-mono text-xs">(User ID: {userId || 'N/A'})</span>
                                    )}
                                </p>
                            </div>
                            <div className="text-center bg-slate-700 px-6 py-3 rounded-xl border border-slate-600">
                                <p className="text-xs text-slate-300 uppercase tracking-wide">Current Payout</p>
                                <p className="text-3xl font-bold text-green-400">{currency} {totalPayable.toFixed(2)}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12">
                            
                            {/* LEFT SIDEBAR (Controls) */}
                            <div className="lg:col-span-4 bg-slate-50 p-6 border-b lg:border-b-0 lg:border-r border-slate-200 flex flex-col gap-6">
                                
                                {/* Staff Name Input */}
                                <div id="name-input-container" className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 transition-all duration-300">
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Staff Name</label>
                                    <input 
                                        type="text" 
                                        value={payslipData.staffName}
                                        onChange={(e) => updatePayslipData('staffName', e.target.value)}
                                        placeholder="e.g. Juan Dela Cruz"
                                        className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50"
                                    />
                                </div>

                                {/* Settings */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Pay Settings</label>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-4">
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => updatePayslipData('payMode', 'daily')} className={`py-2 text-sm font-medium rounded-lg transition-all ${payMode === 'daily' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600'}`}>Daily Rate</button>
                                            <button onClick={() => updatePayslipData('payMode', 'fixed')} className={`py-2 text-sm font-medium rounded-lg transition-all ${payMode === 'fixed' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600'}`}>Fixed Total</button>
                                        </div>
                                        
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-slate-400 font-bold">{currency}</span>
                                            <input 
                                                type="number" 
                                                value={payslipData.rateInput}
                                                onChange={(e) => updatePayslipData('rateInput', parseFloat(e.target.value) || 0)}
                                                className="w-full pl-8 p-2 border rounded-lg outline-none focus:border-blue-500"
                                            />
                                            <span className="absolute right-3 top-3 text-xs text-slate-400">
                                                {payMode === 'daily' ? '/ day' : '/ 15 days'}
                                            </span>
                                        </div>

                                        <div>
                                            <label className="text-xs text-slate-400 block mb-1">Start Date</label>
                                            <input 
                                                type="date" 
                                                value={startDate}
                                                onChange={(e) => updatePayslipData('startDate', e.target.value)}
                                                className="w-full p-2 border rounded-lg text-sm text-slate-600"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Download Button */}
                                <button 
                                    onClick={generatePDF}
                                    className="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition-transform active:scale-95"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Download Payslip (PDF)
                                </button>

                            </div>

                            {/* RIGHT CONTENT (Grid) */}
                            <div className="lg:col-span-8 p-6 bg-white">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg text-slate-700">Attendance Log</h3>
                                    <div className="text-sm font-medium text-slate-500">
                                        {daysPresent} / {totalDays} Days
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    {attendance.map((isPresent, index) => (
                                        <button
                                            key={index}
                                            onClick={() => toggleDay(index)}
                                            className={`
                                                relative p-3 rounded-xl border-2 text-left transition-all group
                                                ${isPresent 
                                                    ? 'border-emerald-400 bg-emerald-50/30' 
                                                    : 'border-slate-100 bg-slate-50 opacity-60 hover:opacity-100'
                                                }
                                            `}
                                        >
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Day {index + 1}</span>
                                                {isPresent && <span className="w-2 h-2 rounded-full bg-emerald-500"></span>}
                                            </div>
                                            <div className="font-semibold text-slate-700 text-sm">
                                                {getDisplayDate(index)}
                                            </div>
                                            <div className={`text-xs mt-1 font-bold ${isPresent ? 'text-emerald-600' : 'text-slate-300'}`}>
                                                {isPresent ? `+${currency}${dailyRate.toFixed(0)}` : 'Absent'}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="mt-6 text-center">
                                    <button onClick={resetAttendance} className="text-xs text-slate-400 hover:text-red-500 underline">
                                        Clear all entries
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>